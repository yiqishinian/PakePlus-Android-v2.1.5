<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YHQ&QHS - AI æ™ºèƒ½è¯†å›¾å•è¯å¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #F5F5F4; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; height: 220px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* é’ˆå¯¹å›¾ç‰‡é¢„è§ˆåŒºåŸŸçš„ä¼˜åŒ– */
        .preview-container { aspect-ratio: 4/3; width: 100%; position: relative; overflow: hidden; }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col pb-10">

    <nav class="w-full bg-white/90 backdrop-blur border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-xl font-bold tracking-tight text-stone-900">YHQ&QHS<span class="text-indigo-600">è¯†å›¾å­¦è‹±è¯­</span></span>
                <span class="bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded-full font-bold">V0.2</span>
            </div>
            <button id="mockBtn" class="text-xs text-stone-400">æ¨¡æ‹Ÿæ•°æ®</button>
        </div>
    </nav>

    <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-6 space-y-6">

        <section class="text-center space-y-2">
            <h1 class="text-2xl font-bold text-stone-900">æ‹ç…§å­¦è‹±è¯­</h1>
            <p class="text-sm text-stone-500">ä¸Šä¼ ç…§ç‰‡ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆå•è¯å¡ç‰‡</p>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 space-y-4">
                <div class="glass-panel rounded-2xl p-4 shadow-sm">
                    <div id="dropZone" class="border-2 border-dashed border-stone-300 rounded-xl p-2 text-center hover:border-indigo-500 hover:bg-indigo-50 transition-all relative overflow-hidden group min-h-[240px] flex flex-col items-center justify-center bg-stone-50">
                        
                        <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer" accept="image/*">
                        
                        <div id="uploadPrompt" class="space-y-3 transition-opacity duration-300 z-0 pointer-events-none">
                            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto shadow-sm border border-stone-100">
                                <span class="text-3xl">ğŸ“¸</span>
                            </div>
                            <div>
                                <p class="font-medium text-stone-700">ç‚¹å‡»æ‹ç…§ / ä¸Šä¼ </p>
                                <p class="text-xs text-stone-400 mt-1">æ”¯æŒç›¸å†Œä¸ç›¸æœº</p>
                            </div>
                        </div>

                        <div id="previewWrapper" class="hidden absolute inset-0 z-20 bg-black/5 flex flex-col items-center justify-center w-full h-full">
                            <img id="imagePreview" class="w-full h-full object-contain p-2" alt="Preview">
                            
                            <div class="absolute bottom-6 flex gap-3 z-30">
                                <button id="reUploadBtn" class="bg-white/90 backdrop-blur text-stone-700 px-4 py-2 rounded-full text-sm font-medium shadow-lg active:scale-95 transition">
                                    é‡é€‰
                                </button>
                                <button id="startBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-indigo-200 active:scale-95 transition flex items-center gap-2">
                                    <span>ğŸš€ å¼€å§‹è¯†åˆ«</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-40">
                            <div class="loader mb-2"></div>
                            <span id="loadingText" class="text-xs font-bold text-indigo-600 animate-pulse">å¤„ç†ä¸­...</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-4 shadow-sm">
                    <h3 class="font-semibold text-sm text-stone-800 mb-2 px-1">ä»Šæ—¥å­¦ä¹ åˆ†ç±»</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div id="emptyState" class="h-64 flex flex-col items-center justify-center text-center border border-stone-100 rounded-2xl bg-white/50 text-stone-400">
                    <div class="text-4xl mb-2 grayscale opacity-20">ğŸ§ </div>
                    <p class="text-sm">å‡†å¤‡å°±ç»ªï¼Œè¯·ä¸Šä¼ å›¾ç‰‡</p>
                </div>

                <div id="resultCard" class="hidden fade-in space-y-4">
                    <div class="bg-white rounded-2xl p-6 shadow-lg border-l-4 border-indigo-500 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="text-[10px] uppercase tracking-wider font-bold text-stone-400">Detected Object</span>
                                <h2 id="resWord" class="text-4xl font-bold text-stone-900 leading-tight my-1">Example</h2>
                                
                                <div class="flex items-center gap-3 mt-2">
                                    <span id="resIpa" class="font-mono text-sm text-stone-500 bg-stone-100 px-1.5 py-0.5 rounded">/ig'zÃ¦mpl/</span>
                                    <div class="flex gap-1">
                                        <button id="btnUK" class="flex items-center gap-1 text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-100 active:scale-95 transition font-bold border border-indigo-100">
                                            ğŸ‡¬ğŸ‡§ UK
                                        </button>
                                        <button id="btnUS" class="flex items-center gap-1 text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-100 active:scale-95 transition font-bold border border-indigo-100">
                                            ğŸ‡ºğŸ‡¸ US
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <div class="text-right">
                                <span class="text-[10px] uppercase tracking-wider font-bold text-stone-400">Meaning</span>
                                <p id="resCn" class="text-2xl font-serif text-stone-700 mt-1">ç¤ºä¾‹</p>
                                <span id="resCategory" class="inline-block mt-1 text-[10px] bg-stone-100 text-stone-500 px-2 rounded-full">General</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
                        <h3 class="font-semibold text-stone-800 mb-3 text-sm flex items-center gap-2">ğŸ“ åŒè¯­ä¾‹å¥</h3>
                        <div id="sentencesList" class="space-y-3">
                            </div>
                    </div>

                    <button onclick="resetUpload()" class="w-full py-3 bg-stone-900 text-white rounded-xl shadow-md font-medium active:scale-95 transition-transform">
                        è¯†åˆ«ä¸‹ä¸€å¼ 
                    </button>
                </div>
            </div>
        </div>

        <section class="pt-6 border-t border-stone-200">
            <h3 class="text-base font-bold text-stone-800 mb-3 px-1">æœ€è¿‘è®°å½• (History)</h3>
            <div id="historyGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                </div>
        </section>

    </main>

    <script>
        // ==========================================
        // ğŸ”‘ é…ç½®åŒºåŸŸ
        // ==========================================
        const API_KEY = "sk-aa6fKhDvt0ONchour9zenVryn0j5UDwbgJ5jklBthoXYrkMm"; 
        const API_ENDPOINT = "https://api.strai.top/v1/chat/completions";
        const API_MODEL = "[0.005]gemini-2.5-flash"; // æˆ– gpt-4o-mini
        const HISTORY_KEY = "YHQ&QHSå­¦è‹±è¯­_data_v0.001";
        // ==========================================

        const els = {
            fileInput: document.getElementById('fileInput'),
            dropZone: document.getElementById('dropZone'),
            previewWrapper: document.getElementById('previewWrapper'),
            preview: document.getElementById('imagePreview'),
            prompt: document.getElementById('uploadPrompt'),
            startBtn: document.getElementById('startBtn'),
            reUploadBtn: document.getElementById('reUploadBtn'),
            loader: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            empty: document.getElementById('emptyState'),
            result: document.getElementById('resultCard'),
            resWord: document.getElementById('resWord'),
            resIpa: document.getElementById('resIpa'),
            resCn: document.getElementById('resCn'),
            resCategory: document.getElementById('resCategory'),
            sentences: document.getElementById('sentencesList'),
            history: document.getElementById('historyGrid'),
            btnUK: document.getElementById('btnUK'),
            btnUS: document.getElementById('btnUS'),
            mockBtn: document.getElementById('mockBtn'),
            chart: document.getElementById('categoryChart')
        };

        // çŠ¶æ€å˜é‡
        let currentFile = null;
        let chartInstance = null;
        let categoryStats = {};

        // --- åˆå§‹åŒ– ---
        initChart();
        loadHistory();

        // --- äº‹ä»¶ç›‘å¬ ---
        els.fileInput.addEventListener('change', handleFileSelect);
        
        els.reUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ dropZone ç‚¹å‡»
            els.fileInput.click();
        });

        // æ ¸å¿ƒï¼šç‚¹å‡»â€œå¼€å§‹è¯†åˆ«â€æ‰æ‰§è¡Œå‹ç¼©å’Œä¸Šä¼ 
        els.startBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!currentFile) return;
            await processAndAnalyze(currentFile);
        });

        els.mockBtn.addEventListener('click', () => runAnalysis(null, true));

        // æ’­æ”¾éŸ³é¢‘é€»è¾‘ (Type: 1=UK, 2=US)
        // ä½¿ç”¨æœ‰é“è¯å…¸æ¥å£ï¼Œè™½ç„¶ä¸æ˜¯å®˜æ–¹APIï¼Œä½†ç¨³å®šä¸”å‘éŸ³æ ‡å‡†
        els.btnUK.addEventListener('click', () => playAudio(1));
        els.btnUS.addEventListener('click', () => playAudio(2));

        function playAudio(type) {
            const word = els.resWord.innerText;
            if(!word) return;
            const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&type=${type}`;
            new Audio(audioUrl).play().catch(e => alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"));
        }

        // --- é€»è¾‘ï¼šé€‰æ‹©æ–‡ä»¶ä¸é¢„è§ˆ ---
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            currentFile = file;

            // 1. ç«‹å³æ˜¾ç¤ºé¢„è§ˆ (ä½¿ç”¨ ObjectURLï¼Œæå¿«)
            const objectUrl = URL.createObjectURL(file);
            els.preview.src = objectUrl;
            
            // 2. åˆ‡æ¢ UI çŠ¶æ€
            els.prompt.classList.add('opacity-0'); // éšè—æç¤º
            els.previewWrapper.classList.remove('hidden'); // æ˜¾ç¤ºé¢„è§ˆå±‚
            
            // 3. éšè— input (é¿å…é®æŒ¡æŒ‰é’®)ï¼Œä½†è¦ä¿ç•™é‡æ–°è§¦å‘çš„èƒ½åŠ›
            els.fileInput.classList.add('hidden');
        }

        // --- é€»è¾‘ï¼šé‡ç½®ä¸Šä¼  ---
        window.resetUpload = function() { // æš´éœ²ç»™å…¨å±€
            els.fileInput.value = '';
            els.fileInput.classList.remove('hidden'); // æ¢å¤ç‚¹å‡»åŒºåŸŸ
            els.fileInput.click();
        }

        // --- é€»è¾‘ï¼šå¤„ç†ä¸åˆ†æ ---
        async function processAndAnalyze(file) {
            setLoading(true, "å‹ç¼©å›¾ç‰‡ä¸­...");
            els.startBtn.classList.add('hidden'); // éšè—å¼€å§‹æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            els.reUploadBtn.classList.add('hidden');

            try {
                // 1. å‹ç¼©å›¾ç‰‡
                const compressedBase64 = await compressImage(file, 1024, 0.7);
                
                // 2. å‘èµ· API è¯·æ±‚
                setLoading(true, "AI æ­£åœ¨è¯†åˆ«...");
                await runAnalysis(compressedBase64);

            } catch (err) {
                console.error(err);
                alert("å‡ºé”™å•¦: " + err.message);
                // æ¢å¤ UI
                els.startBtn.classList.remove('hidden');
                els.reUploadBtn.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }

        // --- å›¾ç‰‡å‹ç¼©ç®—æ³• ---
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = () => reject(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"));
                };
                reader.onerror = (error) => reject(error);
            });
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šAPI è°ƒç”¨ ---
        async function runAnalysis(base64Image, isMock = false) {
            try {
                let data;
                if (isMock) {
                    await new Promise(r => setTimeout(r, 800));
                    data = getMockData();
                    // æ¨¡æ‹Ÿå›¾ç‰‡
                    if (!base64Image) {
                        base64Image = "https://images.unsplash.com/photo-1463936575829-25148e1db1b8?auto=format&fit=crop&w=500&q=80";
                        els.preview.src = base64Image;
                        els.previewWrapper.classList.remove('hidden');
                    }
                } else {
                    if (!API_KEY || API_KEY.includes("xxxx")) throw new Error("è¯·æ£€æŸ¥ API Key");
                    data = await callApi(base64Image);
                }

                renderResult(data);
                saveToHistory(data, base64Image);
                updateChart(data.category);

            } catch (error) {
                throw error; // æŠ›å‡ºç»™ä¸Šå±‚å¤„ç†
            }
        }

        async function callApi(dataURI) {
            const promptText = `
            Identify the main object in this image.
            Return a pure JSON object strictly following this format (no markdown):
            {
                "word": "English Word (Singular)",
                "ipa": "IPA Pronunciation (e.g. /kÃ¦t/)",
                "meaning": "Simple Chinese Meaning",
                "category": "Category (Food, Tech, Nature, Home, Office, Travel)",
                    {"en": "Sentence 1...", "cn": "Translation 1..."},
                    {"en": "Sentence 2...", "cn": "Translation 2..."},
                    {"en": "Sentence 3...", "cn": "Translation 3..."}
                ]
            }
            IMPORTANT: Please provide exactly 3 distinct example sentences varying in complexity.`; 
            // ğŸ‘† å¢åŠ äº† "IMPORTANT" è¿™è¡Œæ˜ç¡®æŒ‡ä»¤ï¼Œå¹¶åœ¨ JSON ç¤ºä¾‹ä¸­æš—ç¤ºäº† 3 ä¸ªä½ç½®

            const payload = {
                model: API_MODEL,
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: promptText },
                            { type: "image_url", image_url: { url: dataURI } }
                        ]
                    }
                ]
            };

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const resData = await response.json();
            if (!resData.choices || resData.choices.length === 0) throw new Error("API è¿”å›ä¸ºç©º");

            let content = resData.choices[0].message.content;
            content = content.replace(/```json|```/g, '').trim();
            return JSON.parse(content);
        }

        // --- UI æ¸²æŸ“ ---
        function renderResult(data) {
            els.empty.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            els.result.scrollIntoView({ behavior: 'smooth', block: 'start' });

            els.resWord.innerText = data.word;
            els.resIpa.innerText = data.ipa || '';
            els.resCn.innerText = data.meaning;
            els.resCategory.innerText = data.category || 'General';

            els.sentences.innerHTML = data.sentences.map(s => `
                <div class="bg-stone-50 p-3 rounded-lg border-l-2 border-stone-300">
                    <p class="text-stone-900 text-sm font-medium leading-relaxed">${s.en}</p>
                    <p class="text-stone-500 text-xs mt-1">${s.cn}</p>
                </div>
            `).join('');
        }

        function setLoading(isLoading, text) {
            if (isLoading) {
                els.loader.classList.remove('hidden');
                els.loadingText.innerText = text;
            } else {
                els.loader.classList.add('hidden');
            }
        }

        // --- å†å²è®°å½•ä¸å›¾è¡¨ (ä¿æŒåŸé€»è¾‘ï¼Œç¨ä½œä¼˜åŒ–) ---
        function saveToHistory(data, imgSrc) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
            const newItem = { id: Date.now(), data: data, img: imgSrc };
            history.unshift(newItem);
            if (history.length > 500) history.pop(); // é™åˆ¶æ•°é‡
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistoryItem(newItem, true);
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
            els.history.innerHTML = '';
            categoryStats = {};
            history.forEach(item => {
                renderHistoryItem(item, false);
                const cat = item.data.category || 'Other';
                categoryStats[cat] = (categoryStats[cat] || 0) + 1;
            });
            updateChart(null, true);
        }

        function renderHistoryItem(item, isNew) {
            const div = document.createElement('div');
            div.className = 'flex flex-col items-center gap-1 cursor-pointer group fade-in';
            div.innerHTML = `
                <div class="w-16 h-16 rounded-xl overflow-hidden border border-stone-200 shadow-sm group-hover:border-indigo-400 transition-colors bg-white relative">
                    <img src="${item.img}" class="w-full h-full object-cover">
                </div>
                <span class="text-[10px] text-stone-600 font-medium truncate w-16 text-center">${item.data.word}</span>
            `;
            div.onclick = () => {
                renderResult(item.data);
                els.preview.src = item.img;
                els.previewWrapper.classList.remove('hidden');
                els.prompt.classList.add('opacity-0');
                els.fileInput.classList.add('hidden');
                els.startBtn.classList.add('hidden'); // å†å²è®°å½•æŸ¥çœ‹ä¸éœ€è¦å¼€å§‹æŒ‰é’®
                els.reUploadBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            if (isNew) els.history.prepend(div);
            else els.history.appendChild(div);
        }

        function initChart() {
            const ctx = els.chart.getContext('2d');
            Chart.defaults.font.family = "'Inter', sans-serif";
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4F46E5', '#06B6D4', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } }, cutout: '75%' }
            });
        }

        function updateChart(newCategory, reloadAll = false) {
            if (!reloadAll && newCategory) {
                categoryStats[newCategory] = (categoryStats[newCategory] || 0) + 1;
            }
            chartInstance.data.labels = Object.keys(categoryStats);
            chartInstance.data.datasets[0].data = Object.values(categoryStats);
            chartInstance.update();
        }

        function getMockData() {
            return {
                word: "Cactus",
                ipa: "/ËˆkÃ¦k.tÉ™s/",
                meaning: "ä»™äººæŒ",
                category: "Nature",
                sentences: [
                    {en: "This cactus has sharp spines.", cn: "è¿™æ ªä»™äººæŒæœ‰å°–é”çš„åˆºã€‚"},
                    {en: "Cacti grow in dry deserts.", cn: "ä»™äººæŒç”Ÿé•¿åœ¨å¹²æ—±çš„æ²™æ¼ é‡Œã€‚"}
                ]
            };
        }
    </script>
</body>
</html>